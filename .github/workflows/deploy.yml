name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  # ====================================================
  # 1. API 서버 배포 (Backend + Nginx + Monitoring Center)
  # ====================================================
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy API via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_API }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            set -e 
            
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # [모니터링 설정] Prometheus에 Worker IP 주입
            sed -i "s/\${WORKER_SERVER_IP}/${{ secrets.HOST_WORKER }}/g" monitoring/prometheus.yml

            # [모니터링 설정] Alloy 로그 수집 권한 부여
            sudo chmod -R 755 /var/lib/docker/containers || true

            # API 서버 컨테이너 빌드
            sudo docker compose -f docker-compose.api.yml --env-file .env.production build --no-cache

            # [순차 배포 1단계] 핵심 서비스 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d backend nginx
            echo "핵심 서비스(Backend, Nginx) 안정화 대기 중 (30초)..."
            sleep 30

            # [순차 배포 2단계] 모니터링 저장소 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d prometheus loki
            echo "모니터링 저장소(Prometheus, Loki) 실행 중 (15초)..."
            sleep 15

            # [순차 배포 3단계] 시각화 및 수집기 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d grafana alloy cadvisor
            echo "모든 모니터링 도구 가동 완료."
            sleep 10

            # DB 마이그레이션 및 데이터 임포트
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py migrate --noinput
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_stacks
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_categories
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_relationships
            
            # 크롤링 및 분석 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py run_crawling
            
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -d backend python manage.py analyze_stackoverflow \
              --posts ./Posts.xml \
              --stacks ./tech_stacks_merged_final.csv \
              --out ./out.csv \
              --limit 50000 \
              --progress 10000 \
              --with-top-posts \
              --detail-tech git \
              --topn 10 \
              --save-db
            
            sudo docker image prune -f

  # ====================================================
  # 2. 워커 서버 배포 (RabbitMQ + Celery + Exporters)
  # ====================================================
  deploy-worker:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    needs: deploy-api 
    
    steps:
      - name: Deploy Worker via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_WORKER }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # 워커 서버 컨테이너 빌드
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production build --no-cache
            
            # [순차 배포 1단계] 브로커 실행
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d rabbitmq
            echo "RabbitMQ 안정화 대기 중 (30초)..."
            sleep 30

            # [순차 배포 2단계] 워커 및 스케줄러 실행
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d celery celery-beat celery-exporter
            echo "Celery 및 모니터링 도구 실행 중 (15초)..."
            sleep 15

            # [순차 배포 3단계] 워커 전용 수집기 실행
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d cadvisor alloy
            
            sudo docker image prune -f