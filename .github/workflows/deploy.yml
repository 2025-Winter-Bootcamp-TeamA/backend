name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  # ====================================================
  # 1. API 서버 배포 (Backend + Nginx + Monitoring Center)
  # ====================================================
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy API via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_API }} # 탄력적 IP 사용 권장
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            set -e 
            
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            # .env.production 생성
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # [모니터링 설정] .env.production에서 Worker Private IP 추출하여 Prometheus에 주입
            WORKER_PRIVATE_IP=$(grep "^WORKER_SERVER_IP=" .env.production | cut -d '=' -f 2)
            sed -i "s/\${WORKER_SERVER_IP}/$WORKER_PRIVATE_IP/g" monitoring/prometheus.yml

            # [모니터링 설정] Alloy 로그 수집 권한 부여
            sudo chmod -R 755 /var/lib/docker/containers || true

            # API 서버 컨테이너 빌드
            sudo docker compose -f docker-compose.api.yml down
            sudo docker system prune -f   # 안 쓰는 캐시 삭제 (안전함)
            sudo docker compose -f docker-compose.api.yml --env-file .env.production build --no-cache
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --force-recreate

            # [순차 배포] 부하 분산을 위한 단계별 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --force-recreate backend nginx
            sleep 30
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --force-recreate prometheus loki
            sleep 15
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --force-recreate grafana alloy cadvisor
            
            # DB 및 초기 데이터 설정
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py migrate --noinput
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_stacks
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_categories
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_relationships
            
            sudo docker image prune -f

  # ====================================================
  # 2. 워커 서버 배포 (RabbitMQ + Celery + Exporters)
  # ====================================================
  deploy-worker:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    needs: deploy-api 
    steps:
      - name: Deploy Worker via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_WORKER }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            cd backend

            # 1. 최신 코드 가져오기
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true

            echo "${{ secrets.ENV_FILE }}" > .env.production

            # 2. Alloy 설정 파일의 환경변수 치환
            sed -i "s/\${API_SERVER_IP}/${{ secrets.HOST_API }}/g" monitoring/worker-config.alloy

            # 3. 변경 확인 (디버깅용)
            echo "=== worker-config.alloy 확인 ==="
            cat monitoring/worker-config.alloy

            # 4. 컨테이너 실행
            sudo docker compose -f docker-compose.worker.yml down --remove-orphans
            sudo docker system prune -f   # 안 쓰는 캐시 삭제 (안전함)
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production build --no-cache
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --force-recreate --remove-orphans
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --force-recreate rabbitmq
            sleep 30
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --force-recreate celery celery-beat
            sleep 15
            
            # 5. 수집기 강제 재시작 (변경된 설정 반영)
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --force-recreate cadvisor alloy
            
            sudo docker image prune -f