name: Deploy to EC2

on:
  push:
    branches: ["main"] # main 브랜치에 푸시될 때 실행

jobs:
  # ====================================================
  # 1. API 서버 배포 (Backend + Nginx)
  # ====================================================
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy API via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_API }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m # 빌드 시간을 고려하여 타임아웃 연장
          script: |
            set -e # 에러 발생 시 즉시 중단
            
            # 1. 프로젝트 폴더로 이동 (폴더가 없으면 clone)
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            # 2. 최신 코드 받기 (로컬 변경사항 무시하고 원격 코드로 강제 업데이트)
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # 3. 환경 변수 파일 생성 (.env.production)
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # 4. API 서버 컨테이너 실행
            # --no-cache를 추가하여 parent snapshot missing 에러 방지
            sudo docker compose -f docker-compose.api.yml --env-file .env.production down
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --build --no-cache --remove-orphans

            # 컨테이너가 정상적으로 뜰 때까지 대기
            sleep 10

            # 5. 데이터베이스 및 초기 데이터 등록 작업
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py migrate --noinput
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_stacks
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_categories
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_relationships
            
            # 6. 크롤링 및 분석 명령어 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py run_crawling
            
            # StackOverflow 데이터 분석 (백그라운드 실행으로 타임아웃 방지)
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -d backend python manage.py analyze_stackoverflow \
              --posts ./Posts.xml \
              --stacks ./tech_stacks_merged_final.csv \
              --out ./out.csv \
              --limit 50000 \
              --progress 10000 \
              --with-top-posts \
              --detail-tech git \
              --topn 10 \
              --save-db
            
            # 7. 불필요한 이미지 정리
            sudo docker image prune -f

  # ====================================================
  # 2. 워커 서버 배포 (RabbitMQ + Celery)
  # ====================================================
  deploy-worker:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    needs: deploy-api # API 배포 완료 후 실행
    
    steps:
      - name: Deploy Worker via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_WORKER }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 20m
          script: |
            set -e # 에러 발생 시 즉시 중단
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            echo "${{ secrets.ENV_FILE }}" > .env.production
            
            # 워커 서버 컨테이너 실행 (빌드 캐시 문제 예방을 위해 --no-cache 추가)
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production down
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --build --no-cache --remove-orphans
            
            sudo docker image prune -f