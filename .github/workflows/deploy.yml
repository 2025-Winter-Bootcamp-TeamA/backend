name: Deploy to EC2

on:
  push:
    branches: ["main"] # main 브랜치에 푸시될 때 실행

jobs:
  # ====================================================
  # 1. API 서버 배포 (Backend + Nginx + Monitoring Center)
  # ====================================================
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy API via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_API }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e # 에러 발생 시 즉시 중단
            
            # 1. 프로젝트 폴더로 이동 (폴더가 없으면 clone)
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            # 2. 최신 코드 받기
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            # 3. 환경 변수 파일 생성 (.env.production)
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # 4. [모니터링 설정] Prometheus에 Worker IP 주입
            # prometheus.yml 내의 ${WORKER_SERVER_IP}를 실제 Worker 서버 IP로 치환
            sed -i "s/\${WORKER_SERVER_IP}/${{ secrets.HOST_WORKER }}/g" monitoring/prometheus.yml

            # 5. [모니터링 설정] Alloy 로그 수집 권한 부여
            # 컨테이너 로그 파일에 접근할 수 있도록 권한 조정
            sudo chmod -R 755 /var/lib/docker/containers || true

            # 6. API 서버 및 모니터링 컨테이너 빌드 및 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production down
            sudo docker compose -f docker-compose.api.yml --env-file .env.production build --no-cache
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --remove-orphans

            sleep 10

            # 7. 데이터베이스 및 초기 데이터 등록 작업
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py migrate --noinput
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_stacks
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_categories
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_relationships
            
            # 8. 크롤링 및 분석 명령어 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py run_crawling
            
            # StackOverflow 데이터 분석 (백그라운드 실행)
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -d backend python manage.py analyze_stackoverflow \
              --posts ./Posts.xml \
              --stacks ./tech_stacks_merged_final.csv \
              --out ./out.csv \
              --limit 50000 \
              --progress 10000 \
              --with-top-posts \
              --detail-tech git \
              --topn 10 \
              --save-db
            
            sudo docker image prune -f

  # ====================================================
  # 2. 워커 서버 배포 (RabbitMQ + Celery + Exporters)
  # ====================================================
  deploy-worker:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    needs: deploy-api # API 배포 완료 후 실행
    
    steps:
      - name: Deploy Worker via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_WORKER }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 20m
          script: |
            set -e
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            echo "${{ secrets.ENV_FILE }}" > .env.production
            
            # 워커 서버 컨테이너 빌드 및 실행
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production down
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production build --no-cache
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --remove-orphans
            
            sudo docker image prune -f