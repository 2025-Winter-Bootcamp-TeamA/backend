name: Deploy to EC2

on:
  push:
    branches: ["main"] # main 브랜치에 푸시될 때 실행

jobs:
  # ====================================================
  # 1. API 서버 배포 (Backend + Nginx)
  # ====================================================
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy API via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_API }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            # 1. 프로젝트 폴더로 이동 (폴더가 없으면 clone)
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            # 2. 최신 코드 받기
            git pull origin main
            
            # 3. 환경 변수 파일 생성 (.env.production)
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # 4. API 서버 컨테이너 실행
            # --env-file 옵션을 사용하여 .env.production을 적용합니다.
            sudo docker compose -f docker-compose.api.yml --env-file .env.production down
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --build --remove-orphans

            # 5. 데이터베이스 및 초기 데이터 등록 작업
            # GitHub Actions 환경이므로 -T 옵션을 반드시 사용합니다.
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py migrate --noinput
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_stacks
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_categories
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_relationships
            
            # 6. 크롤링 및 분석 명령어 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py run_crawling
            
            # StackOverflow 데이터 분석 (Posts.xml 경로 주의)
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py analyze_stackoverflow \
              --posts ./Posts.xml \
              --stacks ./tech_stacks_merged_final.csv \
              --out ./out.csv \
              --limit 50000 \
              --progress 10000 \
              --with-top-posts \
              --detail-tech git \
              --topn 10 \
              --save-db
            
            # 7. 불필요한 이미지 정리
            docker image prune -f

  # ====================================================
  # 2. 워커 서버 배포 (RabbitMQ + Celery)
  # ====================================================
  deploy-worker:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    needs: deploy-api  # API 배포 완료 후 실행
    
    steps:
      - name: Deploy Worker via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_WORKER }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git pull origin main
            
            # 환경 변수 파일 생성 (.env.production)
            echo "${{ secrets.ENV_FILE }}" > .env.production
            
            # 워커 서버 컨테이너 실행
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production down
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --build --remove-orphans
            
            docker image prune -f