name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  # ====================================================
  # 1. API 서버 배포 (Backend + Nginx + Monitoring Center)
  # ====================================================
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy API via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_API }} # 탄력적 IP 사용 권장
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 40m
          script: |
            set -e 
            
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend
            
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            # .env.production 생성
            echo "${{ secrets.ENV_FILE }}" > .env.production

            # [모니터링 설정] Prometheus에 Worker IP 주입
            sed -i "s/\${WORKER_SERVER_IP}/${{ secrets.HOST_WORKER }}/g" monitoring/prometheus.yml

            # [모니터링 설정] Alloy 로그 수집 권한 부여
            sudo chmod -R 755 /var/lib/docker/containers || true

            # API 서버 컨테이너 빌드 (requirements.txt의 PyPDF2 반영을 위해 --no-cache 유지)
            sudo docker compose -f docker-compose.api.yml --env-file .env.production build --no-cache

            # [순차 배포] 부하 분산을 위한 단계별 실행
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d backend nginx
            sleep 30
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --force-recreate prometheus loki
            sleep 15
            sudo docker compose -f docker-compose.api.yml --env-file .env.production up -d --force-recreate grafana alloy cadvisor
            
            # DB 및 초기 데이터 설정
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py migrate --noinput
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_stacks
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_categories
            sudo docker compose -f docker-compose.api.yml --env-file .env.production exec -T backend python manage.py import_tech_relationships
            
            sudo docker image prune -f

  # ====================================================
  # 2. 워커 서버 배포 (RabbitMQ + Celery + Exporters)
  # ====================================================
  deploy-worker:
    name: Deploy Worker Server
    runs-on: ubuntu-latest
    needs: deploy-api 
    
    steps:
      - name: Deploy Worker via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_WORKER }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            if [ ! -d "backend" ]; then
              git clone https://github.com/2025-Winter-Bootcamp-TeamA/backend.git backend
            fi
            cd backend

            # [중요] 1. 기존에 잘못 생성된 파일/디렉토리 제거 (Git 초기화 전 수행)
            sudo rm -rf monitoring/worker-config.alloy
            
            # 2. 최신 코드를 가져옴 (이때 정상적인 worker-config.alloy 파일이 생성됨)
            git fetch origin
            git reset --hard origin/main
            git clean -fd -e letsencrypt/ || true
            
            echo "${{ secrets.ENV_FILE }}" > .env.production
            
            # 3. Alloy 설정 내 API 서버의 탄력적 IP 주입 (Loki 주소)
            sed "s/\${API_SERVER_IP}/${{ secrets.HOST_API }}/g" monitoring/worker-config.alloy.tmp > monitoring/worker-config.alloy

            # 워커 서버 컨테이너 빌드
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production build --no-cache
            
            # [순차 배포] 브로커 선행 실행 필수
            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d rabbitmq
            echo "RabbitMQ 안정화 대기 중 (30초)..."
            sleep 30

            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d celery celery-beat celery-exporter
            sleep 15

            sudo docker compose -f docker-compose.worker.yml --env-file .env.production up -d --force-recreate cadvisor alloy
            
            sudo docker image prune -f